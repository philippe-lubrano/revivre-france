<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="REVIVRE-FRANCE - Refonte moderne pour iframe ASO Connect">
  <title>REVIVRE-FRANCE - Refonte Moderne</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="iframe-container">
    <main>
      <section class="hero" id="accueil">
        <div class="container">
          <h1>REVIVRE-FRANCE</h1>
          <p class="hero-subtitle">L'association des personnes qui souffrent de Troubles Anxieux</p>
          <p class="hero-description">Association indépendante, soutenue par des professionnels en santé mentale.</p>
          <div class="hero-buttons">
            <a href="https://www.revivre-france.org/page/587643-j-adhere" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Adhérer à l'Association</a>
            <a href="https://www.revivre-france.org/collect/description/200648-e-don-a-revivre-france" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">Faire un Don</a>
          </div>
        </div>
      </section>

      <section class="section" id="troubles">
        <div class="container">
          <h2 class="section-title">À qui s'adresse notre association ?</h2>
          <p class="section-subtitle">Nous soutenons les personnes souffrant de différents types de troubles anxieux</p>
          <div class="grid grid-4">
            <div class="card card-with_illustration phobie">
              <img src="assets/phobie-sociale-cartoon.png" alt="Illustration phobie sociale" class="card-image">
              <div class="card-content">
                <h3>Phobie Sociale</h3>
                <p>Peur intense des situations sociales et du jugement des autres</p>
              </div>
            </div>
            <div class="card card-with_illustration anxiete">
              <img src="assets/tag-cartoon.png" alt="Illustration anxiété généralisée" class="card-image">
              <div class="card-content">
                <h3>Anxiété Généralisée</h3>
                <p>Inquiétude excessive et persistante dans la vie quotidienne</p>
              </div>
            </div>
            <div class="card card-with_illustration panique">
              <img src="assets/panique-cartoon.png" alt="Illustration trouble panique" class="card-image">
              <div class="card-content">
                <h3>Trouble Panique</h3>
                <p>Attaques de panique récurrentes et imprévisibles</p>
              </div>
            </div>
            <div class="card card-with_illustration agoraphobie">
              <img src="assets/agoraphobie-cartoon.png" alt="Illustration agoraphobie" class="card-image">
              <div class="card-content">
                <h3>Agoraphobie</h3>
                <p>Peur des espaces ouverts ou des situations dont il est difficile de s'échapper</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section section-gray" id="services">
        <div class="container">
          <h2 class="section-title">Ce que nous proposons</h2>
          <p class="section-subtitle">Un accompagnement complet pour vous aider à mieux vivre avec vos troubles anxieux</p>
          <div class="grid grid-3">
            <a class="card card-with_illustration" href="#agenda">
              <img src="assets/groupe.png" alt="Groupes de Parole" class="card-image">
              <h3>Groupes de Parole</h3>
              <p>Rencontrez d'autres personnes dans un cadre bienveillant et sans jugement. Nos groupes de parole sont animés par les pairs, sans professionnels de santé.</p>
            </a>
            <a class="card card-with_illustration" href="#agenda">
              <img src="assets/sorties.png" alt="Sorties" class="card-image">
              <h3>Sorties</h3>
              <p>Participez à des activités en groupe pour briser l'isolement et reprendre confiance en vous dans un environnement soutenant.</p>
            </a>
            <a class="card card-with_illustration" href="#agenda">
              <img src="assets/meditation.png" alt="Ateliers" class="card-image">
              <h3>Ateliers</h3>
              <p>Découvrez des techniques pratiques et des outils pour mieux gérer votre anxiété au quotidien.</p>
            </a>
            <a class="card card-with_illustration" href="https://www.revivre-france.org/page/586148-les-troubles-anxieux" target="_blank">
              <img src="assets/site.png" alt="Site d'Information" class="card-image">
              <h3>Site d'Information</h3>
              <p>Accédez à une mine d'informations sur les troubles anxieux, les traitements et les ressources disponibles.</p>
            </a>
            <a class="card card-with_illustration" href="https://forum.revivre-france.org/" target="_blank">
              <img src="assets/forum.png" alt="Forum" class="card-image">
              <h3>Forum</h3>
              <p>Un espace d’échange et de soutien, basé sur nos valeurs de bienveillance, respect, entraide et écoute mutuelle.</p>
            </a>
            <a class="card card-with_illustration" href="https://www.revivre-france.org/page/598950-associations" target="_blank">
              <img src="assets/partenaires.png" alt="Partenariats" class="card-image">
              <h3>Partenariats</h3>
              <p>Nous collaborons avec des professionnels de santé et d'autres associations pour vous offrir le meilleur soutien.</p>
            </a>
          </div>
        </div>
      </section>

      <section class="section section-blue">
        <div class="container">
          <div class="highlight-box">
            <h3>Une approche unique : les groupes de parole entre pairs</h3>
            <p>Nos groupes de parole sont animés par les participants eux-mêmes, sans la présence de professionnels de santé. Cette approche permet de créer un espace d'échange libre et authentique, où chacun peut partager son vécu sans crainte du jugement. Vous n'êtes pas seul dans votre parcours.</p>
          </div>
        </div>
      </section>

      <section class="section" id="agenda">
        <div class="container">
          <h2 class="section-title">Prochains événements</h2>
          <p class="section-subtitle">Rejoignez-nous lors de nos prochaines rencontres</p>
          <div id="agenda-events"><!-- dynamic events will be injected here --></div>

          <!-- Fallback static markup (visible while loading / if API fails) -->
          <div id="agenda-fallback" class="grid grid-1">
            <div class="event-card">
              <div class="event-date">
                <span class="day">--</span>
                <span class="month">----</span>
              </div>
              <div class="event-content">
                <h3>Groupe de Parole</h3>
                <p class="event-info">----- -----</p>
                <p>Échange bienveillant entre pairs sur l'anxiété.</p>
              </div>
            </div>
            <div class="event-card">
              <div class="event-date">
                <span class="day">--</span>
                <span class="month">----</span>
              </div>
              <div class="event-content">
                <h3>Atelier Gestion Stress</h3>
                <p class="event-info">----- -----</p>
                <p>Techniques pratiques pour gérer le stress quotidien.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section" id="temoignages">
        <div class="container">
          <h2 class="section-title">Témoignages de nos membres</h2>
          <p class="section-subtitle">Découvrez comment REVIVRE-FRANCE a aidé d'autres personnes</p>
          <div class="grid grid-2">
            <div class="card">
              <div class="card-content">
                <p>"Grâce aux groupes de parole, je ne me sens plus seule avec mon anxiété. L'écoute bienveillante m'a permis de reprendre confiance."</p>
                <cite>- Marie, 34 ans</cite>
              </div>
            </div>
            <div class="card">
              <div class="card-content">
                <p>"Les ateliers m'ont donné des outils concrets pour gérer mes attaques de panique. Une vraie bouffée d'air frais."</p>
                <cite>- Thomas, 28 ans</cite>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section section-gray" id="adhesion">
        <div class="container">
          <h2 class="section-title">Vous pouvez nous aider</h2>
          <p class="section-subtitle">Votre soutien nous permet de continuer notre mission</p>
          <div class="grid grid-2">
            <div class="card card-cta">
              <h3>Adhérer à l'association</h3>
              <p>Devenez membre de REVIVRE-FRANCE et participez activement à la vie de l'association. Votre adhésion nous aide à organiser plus d'événements et à soutenir davantage de personnes.</p>
              <a href="https://www.revivre-france.org/page/587643-j-adhere" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Adhérer maintenant</a>
            </div>
            <div class="card card-cta">
              <h3>Faire un don</h3>
              <p>Chaque contribution, quelle que soit sa taille, fait une différence. Votre don nous permet de maintenir nos activités gratuites et accessibles à tous.</p>
              <a href="https://www.revivre-france.org/collect/description/200648-e-don-a-revivre-france" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Faire un don</a>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function(){
      async function fetchAgenda() {
        const start = new Date();
        const end = new Date(start);
        end.setDate(end.getDate() + 30);

        const fmt = d => d.toISOString().slice(0,10);

        const apiUrl = 'https://api-proxy-revivre.philippe-lubranolavadera.workers.dev/';

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);

        const form = new FormData();
        form.append('id', '129622');
        form.append('pageId', '580895');
        form.append('start', fmt(start));
        form.append('end', fmt(end));

        try {
          const res = await fetch(apiUrl, {
            method: 'POST',
            referrerPolicy: 'origin-when-cross-origin',
            signal: controller.signal,
            body: form
          });
          clearTimeout(timeout);

          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          renderEvents(data);
        } catch (err) {
          console.warn('Agenda fetch failed:', err);
        }
      }

      function renderEvents(items) {
        if (!Array.isArray(items) || items.length === 0) return;
        const container = document.getElementById('agenda-events');
        if (!container) return;

        const filtered = items
          .map(it => {
            const ds = it.date || it.start || it.eventDate || '';
            const t = new Date(ds);
            return Object.assign({}, it, { __ts: isNaN(t) ? null : t.getTime() });
          })
          .filter(it => it.__ts !== null);

        if (filtered.length === 0) return;

        filtered.sort((a, b) => a.__ts - b.__ts);

        container.innerHTML = '';
        const fallback = document.getElementById('agenda-fallback');
        if (fallback) fallback.style.display = 'none';

        const cards = filtered.map(buildEventCard);
        if (cards.length > 1) {
          container.appendChild(buildAgendaCarousel(cards));
        } else {
          const grid = document.createElement('div');
          grid.className = 'grid grid-1';
          grid.appendChild(cards[0]);
          container.appendChild(grid);
        }
      }

      function buildEventCard(it) {
        const card = document.createElement('div');
        card.className = 'event-card';

        const dateCol = document.createElement('div');
        dateCol.className = 'event-date';

        const day = document.createElement('div');
        day.className = 'day';
        const d = parseDateForDisplay(it.date || it.start || it.eventDate);
        day.textContent = d.day;

        const month = document.createElement('div');
        month.className = 'month';
        month.textContent = d.month;

        // ajoute les horaires si disponibles it.start et it.end
        if (it.start && it.end) {
          const startDate = new Date(it.start);
          const endDate = new Date(it.end);
          if (!isNaN(startDate) && !isNaN(endDate) && startDate.getHours() !== 0) {
            const options = { hour: '2-digit', minute: '2-digit' };
            const timeStr = startDate.toLocaleTimeString('fr-FR', options) + ' - ' + endDate.toLocaleTimeString('fr-FR', options);
            const timeElem = document.createElement('div');
            timeElem.textContent = timeStr;
            month.appendChild(document.createElement('br'));
            month.appendChild(timeElem);
          }
        }

        dateCol.appendChild(day);
        dateCol.appendChild(month);

        const content = document.createElement('div');
        content.className = 'event-content';

        const title = document.createElement('h3');
        title.textContent = it.title || it.name || 'Événement';

        const info1 = document.createElement('p');
        info1.className = 'event-info';
        info1.textContent = it.location || it.venue || '';

        const info2 = document.createElement('p');
        info2.className = 'event-info';
        info2.textContent = it.time || it.startTime || '';

        const desc = document.createElement('p');
        const fullDesc = normalizeText(it.description || '');
        const MAX_DESC_CHARS = 220;
        const isLong = fullDesc.length > MAX_DESC_CHARS;
        desc.className = 'event-desc';
        desc.textContent = isLong ? (fullDesc.slice(0, MAX_DESC_CHARS).trimEnd() + '…') : fullDesc;

        const signupUrl = normalizeUrl(it && it.buttonUrl);

        if (signupUrl) {
          const signup = document.createElement('a');
          signup.className = 'event-signup';
          signup.href = signupUrl;
          signup.target = '_blank';
          signup.rel = 'noopener noreferrer';
          signup.textContent = "S'inscrire";
          signup.setAttribute('aria-label', "S'inscrire à l'événement");
          card.appendChild(signup);
        }

        content.appendChild(title);
        if (info1.textContent) content.appendChild(info1);
        if (info2.textContent) content.appendChild(info2);
        if (desc.textContent) {
          content.appendChild(desc);

          if (isLong) {
            const more = document.createElement('button');
            more.type = 'button';
            more.className = 'event-more';
            more.textContent = 'Afficher plus…';
            more.addEventListener('click', () => openAgendaModal({
              title: title.textContent,
              date: formatEventDate(it),
              location: info1.textContent,
              time: deriveEventTime(it) || info2.textContent,
              description: fullDesc
            }));
            content.appendChild(more);
          }
        }

        card.appendChild(dateCol);
        card.appendChild(content);

        return card;
      }

      function normalizeText(value) {
        return String(value || '').replace(/\s+/g, ' ').trim();
      }

      function normalizeUrl(value) {
        const raw = String(value || '').trim();
        if (!raw) return '';
        try {
          return new URL(raw, window.location.href).toString();
        } catch {
          return '';
        }
      }

      function formatEventDate(it) {
        const ds = it.date || it.start || it.eventDate || '';
        const d = new Date(ds);
        if (isNaN(d)) return '';
        const day = String(d.getDate()).padStart(2,'0');
        const month = d.toLocaleString('fr-FR', { month: 'long' });
        const year = d.getFullYear();
        return `${day} ${month} ${year}`;
      }

      function deriveEventTime(it) {
        if (!(it && it.start && it.end)) return '';
        const startDate = new Date(it.start);
        const endDate = new Date(it.end);
        if (isNaN(startDate) || isNaN(endDate)) return '';
        if (startDate.getHours() === 0 && startDate.getMinutes() === 0) return '';
        const options = { hour: '2-digit', minute: '2-digit' };
        return startDate.toLocaleTimeString('fr-FR', options) + ' - ' + endDate.toLocaleTimeString('fr-FR', options);
      }

      function ensureAgendaModal() {
        let root = document.getElementById('agenda-modal');
        if (root) return root;

        root = document.createElement('div');
        root.id = 'agenda-modal';
        root.className = 'agenda-modal';
        root.setAttribute('aria-hidden', 'true');

        const dialog = document.createElement('div');
        dialog.className = 'agenda-modal-dialog';
        dialog.setAttribute('role', 'dialog');
        dialog.setAttribute('aria-modal', 'true');
        dialog.setAttribute('aria-labelledby', 'agenda-modal-title');

        const header = document.createElement('div');
        header.className = 'agenda-modal-header';

        const title = document.createElement('h3');
        title.className = 'agenda-modal-title';
        title.id = 'agenda-modal-title';

        const close = document.createElement('button');
        close.type = 'button';
        close.className = 'agenda-modal-close';
        close.setAttribute('aria-label', 'Fermer');
        close.textContent = '×';

        const body = document.createElement('div');
        body.className = 'agenda-modal-body';
        body.id = 'agenda-modal-body';

        header.appendChild(title);
        header.appendChild(close);
        dialog.appendChild(header);
        dialog.appendChild(body);
        root.appendChild(dialog);

        function closeModal() {
          root.classList.remove('is-open');
          root.setAttribute('aria-hidden', 'true');
          restoreScrollLock();
        }

        close.addEventListener('click', closeModal);
        root.addEventListener('click', (e) => {
          if (e.target === root) closeModal();
        });
        document.addEventListener('keydown', (e) => {
          if (root.classList.contains('is-open') && e.key === 'Escape') {
            e.preventDefault();
            closeModal();
          }
        });

        document.body.appendChild(root);
        return root;
      }

      let __scrollLockPrev = null;
      function applyScrollLock() {
        if (__scrollLockPrev) return;
        const y = window.scrollY || window.pageYOffset || 0;
        __scrollLockPrev = {
          scrollY: y,
          htmlOverflow: document.documentElement.style.overflow,
          bodyOverflow: document.body.style.overflow,
          bodyPosition: document.body.style.position,
          bodyTop: document.body.style.top,
          bodyLeft: document.body.style.left,
          bodyRight: document.body.style.right,
          bodyWidth: document.body.style.width
        };

        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.top = `-${y}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';
      }

      function restoreScrollLock() {
        if (!__scrollLockPrev) return;
        const y = __scrollLockPrev.scrollY || 0;

        document.documentElement.style.overflow = __scrollLockPrev.htmlOverflow;
        document.body.style.overflow = __scrollLockPrev.bodyOverflow;
        document.body.style.position = __scrollLockPrev.bodyPosition;
        document.body.style.top = __scrollLockPrev.bodyTop;
        document.body.style.left = __scrollLockPrev.bodyLeft;
        document.body.style.right = __scrollLockPrev.bodyRight;
        document.body.style.width = __scrollLockPrev.bodyWidth;
        __scrollLockPrev = null;

        // Restaure la position de scroll sans "jump".
        window.scrollTo(0, y);
      }

      function openAgendaModal(data) {
        const root = ensureAgendaModal();
        const titleEl = root.querySelector('#agenda-modal-title');
        const bodyEl = root.querySelector('#agenda-modal-body');
        const closeBtn = root.querySelector('.agenda-modal-close');
        if (!titleEl || !bodyEl || !closeBtn) return;

        titleEl.textContent = data.title || 'Événement';
        bodyEl.innerHTML = '';

        const metaParts = [data.date, data.time, data.location].filter(Boolean);
        if (metaParts.length) {
          const meta = document.createElement('p');
          meta.className = 'agenda-modal-meta';
          meta.textContent = metaParts.join(' • ');
          bodyEl.appendChild(meta);
        }

        if (data.description) {
          const p = document.createElement('p');
          p.textContent = data.description;
          bodyEl.appendChild(p);
        }

        applyScrollLock();
        root.classList.add('is-open');
        root.setAttribute('aria-hidden', 'false');
        closeBtn.focus();
      }

      function buildAgendaCarousel(cards) {
        let index = 0;

        const root = document.createElement('div');
        root.className = 'agenda-carousel';
        root.setAttribute('role', 'region');
        root.setAttribute('aria-label', 'Prochains événements');

        const viewport = document.createElement('div');
        viewport.className = 'agenda-carousel-viewport';

        const track = document.createElement('div');
        track.className = 'agenda-carousel-track';

        const dots = document.createElement('div');
        dots.className = 'agenda-carousel-dots';

        const prevBtn = document.createElement('button');
        prevBtn.type = 'button';
        prevBtn.className = 'agenda-carousel-btn prev';
        prevBtn.setAttribute('aria-label', 'Événement précédent');
        prevBtn.textContent = '‹';

        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'agenda-carousel-btn next';
        nextBtn.setAttribute('aria-label', 'Événement suivant');
        nextBtn.textContent = '›';

        const dotButtons = cards.map((_, i) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'agenda-carousel-dot';
          b.setAttribute('aria-label', `Aller à l'événement ${i + 1}`);
          b.addEventListener('click', () => goTo(i));
          dots.appendChild(b);
          return b;
        });

        cards.forEach((card) => {
          const slide = document.createElement('div');
          slide.className = 'agenda-carousel-slide';
          slide.appendChild(card);
          track.appendChild(slide);
        });

        viewport.appendChild(track);
        root.appendChild(prevBtn);
        root.appendChild(nextBtn);
        root.appendChild(viewport);
        root.appendChild(dots);

        function clamp(nextIndex) {
          const len = cards.length;
          return (nextIndex % len + len) % len;
        }

        function update() {
          const w = viewport.clientWidth || 1;
          track.style.transform = `translateX(${-index * w}px)`;
          dotButtons.forEach((b, i) => b.setAttribute('aria-current', i === index ? 'true' : 'false'));
        }

        function goTo(nextIndex) {
          index = clamp(nextIndex);
          update();
        }

        prevBtn.addEventListener('click', () => goTo(index - 1));
        nextBtn.addEventListener('click', () => goTo(index + 1));

        root.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            goTo(index - 1);
          }
          if (e.key === 'ArrowRight') {
            e.preventDefault();
            goTo(index + 1);
          }
        });

        let startX = 0;
        let startY = 0;
        let isSwiping = false;

        viewport.addEventListener('touchstart', (e) => {
          if (e.touches.length !== 1) return;
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          isSwiping = false;
        }, { passive: true, capture: true });

        viewport.addEventListener('touchmove', (e) => {
          if (e.touches.length !== 1) return;
          const dx = e.touches[0].clientX - startX;
          const dy = e.touches[0].clientY - startY;
          if (Math.abs(dx) > 12 && Math.abs(dx) > Math.abs(dy)) {
            isSwiping = true;
            e.preventDefault();
          }
        }, { passive: false, capture: true });

        viewport.addEventListener('touchend', (e) => {
          if (!isSwiping) return;
          const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
          if (!t) return;
          const dx = t.clientX - startX;
          if (dx > 50) goTo(index - 1);
          if (dx < -50) goTo(index + 1);
        }, { passive: true, capture: true });

        new ResizeObserver(() => update()).observe(viewport);
        update();

        return root;
      }

      function parseDateForDisplay(dateStr) {
        if (!dateStr) return { day: '', month: '' };
        const d = new Date(dateStr);
        if (isNaN(d)) return { day: '', month: '' };
        const day = String(d.getDate()).padStart(2,'0');
        const month = d.toLocaleString('fr-FR', { month: 'long' });
        return { day, month };
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fetchAgenda);
      } else {
        fetchAgenda();
      }
    })();
  </script>

  <script>
    // Fallback "anti-scroll bloqué" (Android Chrome) quand la page est intégrée
    // dans une iframe d'un widget (CRM) et que le scroll natif devient intermittent.
    (function () {
      if (window.self === window.top) return;

      const ua = navigator.userAgent || '';
      const isAndroidChrome = /Android/i.test(ua) && /Chrome\//i.test(ua);
      if (!isAndroidChrome) return;

      const interactiveSelector = 'a, button, input, textarea, select, label, summary, details, [contenteditable="true"]';

      function hasScrollableAncestor(element) {
        for (let node = element; node && node !== document.body; node = node.parentElement) {
          const style = window.getComputedStyle(node);
          const overflowY = style.overflowY;
          if ((overflowY === 'auto' || overflowY === 'scroll') && node.scrollHeight > node.clientHeight + 1) {
            return true;
          }
        }
        return false;
      }

      let active = false;
      let lastX = 0;
      let lastY = 0;
      let lastScrollY = 0;
      let stuckMoves = 0;
      let forcing = false;
      let accumDy = 0;
      let parentAccum = 0;
      let canScrollParent = null;

      function relayScrollToParent(deltaY) {
        // deltaY suit la convention window.scrollBy: + => scroll vers le bas.
        // 1) On notifie toujours le parent (si jamais il écoute).
        try {
          window.parent.postMessage({ type: 'revivre:scroll', deltaY }, '*');
        } catch {
          // ignore
        }

        // 2) Tentative directe si même-origin (ou si le navigateur l'autorise).
        if (canScrollParent === false) return false;
        if (canScrollParent === null) {
          try {
            window.parent.scrollBy(0, 0);
            canScrollParent = true;
          } catch {
            canScrollParent = false;
            return false;
          }
        }

        try {
          window.parent.scrollBy(0, deltaY);
          return true;
        } catch {
          canScrollParent = false;
          return false;
        }
      }

      document.addEventListener('touchstart', (event) => {
        if (event.touches.length !== 1) {
          active = false;
          return;
        }

        const target = event.target;
        const startedOnInteractive = !!(target && target.closest && target.closest(interactiveSelector));
        const startedOnScrollable = !!(target && target.closest && hasScrollableAncestor(target));
        active = !startedOnInteractive && !startedOnScrollable;

        const t = event.touches[0];
        lastX = t.clientX;
        lastY = t.clientY;

        lastScrollY = window.scrollY || window.pageYOffset || 0;
        stuckMoves = 0;
        forcing = false;
        accumDy = 0;
      }, { passive: true, capture: true });

      document.addEventListener('touchmove', (event) => {
        if (!active || event.touches.length !== 1) return;

        const t = event.touches[0];
        const dx = t.clientX - lastX;
        const dy = t.clientY - lastY;

        // On ne force que le scroll vertical.
        if (Math.abs(dy) < Math.abs(dx)) {
          lastX = t.clientX;
          lastY = t.clientY;
          return;
        }

        const scrollingElement = document.scrollingElement || document.documentElement;
        const maxScroll = scrollingElement.scrollHeight - window.innerHeight;
        if (maxScroll <= 0) return;

        const currentScrollY = window.scrollY || window.pageYOffset || 0;
        const atTop = currentScrollY <= 0;
        const atBottom = currentScrollY >= (maxScroll - 1);
        // dy > 0 : doigt vers le bas => tentative de scroll vers le haut
        // dy < 0 : doigt vers le haut => tentative de scroll vers le bas
        const tryingPastTop = atTop && dy > 0;
        const tryingPastBottom = atBottom && dy < 0;

        if (!tryingPastTop && !tryingPastBottom) {
          parentAccum = 0;
        }

        // Par défaut, on laisse le navigateur scroller normalement.
        // On ne "prend la main" que si le scroll natif semble bloqué.
        if (!forcing) {
          // Important : si on est à une extrémité et qu'on "pousse" au-delà,
          // on n'interfère pas. Ça permet au scroll de la page parente de prendre le relais.
          if (tryingPastTop || tryingPastBottom) {
            // Tentative de relais vers la page parente.
            parentAccum += (-dy);
            if (Math.abs(parentAccum) >= 10) {
              const relayed = relayScrollToParent(parentAccum);
              parentAccum = 0;
              // Si on a pu relayer, on évite le "bounce" dans l'iframe.
              if (relayed) event.preventDefault();
            }
            stuckMoves = 0;
            lastScrollY = currentScrollY;
            lastX = t.clientX;
            lastY = t.clientY;
            return;
          }

          const bigEnoughMove = Math.abs(dy) >= 6;

          if (bigEnoughMove && currentScrollY === lastScrollY) {
            stuckMoves += 1;
          } else {
            stuckMoves = 0;
          }

          lastScrollY = currentScrollY;

          // Après quelques mouvements sans progression de scroll, on active le mode "force".
          if (stuckMoves >= 2) {
            forcing = true;
            accumDy = 0;
          }

          lastX = t.clientX;
          lastY = t.clientY;
          return;
        }

        // Mode "force" : le geste devient un scroll programmatique.
        // Si on est à une extrémité et qu'on pousse au-delà, on relâche la main
        // pour laisser le scroll se chaîner vers la page parente.
        if (tryingPastTop || tryingPastBottom) {
          forcing = false;
          stuckMoves = 0;
          accumDy = 0;
          parentAccum += (-dy);
          if (Math.abs(parentAccum) >= 10) {
            const relayed = relayScrollToParent(parentAccum);
            parentAccum = 0;
            if (relayed) event.preventDefault();
          }
          lastScrollY = currentScrollY;
          lastX = t.clientX;
          lastY = t.clientY;
          return;
        }

        event.preventDefault();
        accumDy += dy;
        if (Math.abs(accumDy) >= 8) {
          window.scrollBy(0, -accumDy);
          accumDy = 0;
        }

        lastX = t.clientX;
        lastY = t.clientY;
      }, { passive: false, capture: true });

      document.addEventListener('touchend', () => {
        active = false;
        forcing = false;
        accumDy = 0;
        parentAccum = 0;
      }, { passive: true, capture: true });
      document.addEventListener('touchcancel', () => {
        active = false;
        forcing = false;
        accumDy = 0;
        parentAccum = 0;
      }, { passive: true, capture: true });
    })();
  </script>
</body>
</html>
